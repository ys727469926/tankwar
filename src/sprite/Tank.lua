---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by yangsen.
--- DateTime: 2018/8/8 18:46
---


local common = require("common")
local Bullet = require("sprite.Bullet")
local size = cc.Director:getInstance():getWinSize()


local Tank = class("Tank", function(tankName)
    return cc.Sprite:create()
end)

function Tank:create(tankName)
    local sprite = Tank.new(tankName)
    return sprite
end

function Tank:ctor(tankName)
    cclog("tank init")
    --标记当前方向 1-up 2-right 3-down 4-left
    self.direction = 1
    self.isMoving = false
    self.currentMoveAction = nil
    self.fireCalmDown = false


    --保存重复动画？
    self.moveAnimation = nil

    local spriteFrame = cc.SpriteFrameCache:getInstance()
    spriteFrame:addSpriteFrames("tank.plist")
    self:setSpriteFrame(tankName)

    local animation = cc.Animation:create()
    for i = 1, 2 do
        local frameName = string.format("tank_move_%d.png", i)
        --cclog("frameName = %s", frameName)
        local tankFrame = spriteFrame:getSpriteFrame(frameName)
        animation:addSpriteFrame(tankFrame)
    end

    animation:setDelayPerUnit(0.15)
    animation:setRestoreOriginalFrame(true)
    local action = cc.Animate:create(animation)
    action:retain()
    self.moveAnimation = action
end

function Tank:setFireCalmDown()
    self.fireCalmDown = false
end

-- 获取当前方向
function Tank:getCurrentDirection()
    return self.direction
end

-- 设置当前方向
function Tank:setCurrentDirection(direction)
    self.direction = direction
end

--坦克移动函数
function Tank:tankMove(tag)
    local tankX, tankY = self:getPosition()

    local tankMoveToCurrentDirection = function(direction)
        local time, destination = common.initMoveTo(direction, 0.005, tankX, tankY, size.width - 248 - 30, 248 + 30, 610, 30)
        self.currentMoveAction = cc.MoveTo:create(time, destination)

        --self:startMoveAction

        self:runAction(cc.RepeatForever:create(self.moveAnimation:clone()))
        self:runAction(self.currentMoveAction)
        self.isMoving = true
    end

    local tankTurnToCurrentDirection = function(direction)
        local rotate
        for i = 1, 4 do
            if direction == i then
                rotate = cc.RotateTo:create(0, 90 * (i - 1))
                break
            end
        end
        self:runAction(rotate)
        self:setCurrentDirection(direction)
    end

    local direction = self:getCurrentDirection()
    if self.isMoving then
        if direction ~= tag then
            self:stopAction(self.currentMoveAction)
            tankTurnToCurrentDirection(tag)
            self:runAction(cc.RepeatForever:create(self.moveAnimation:clone()))
        end
    else
        if direction ~= tag then
            tankTurnToCurrentDirection(tag)
        end
        self:runAction(cc.RepeatForever:create(self.moveAnimation:clone()))
        tankMoveToCurrentDirection(tag)
    end

end

--坦克停止函数
function Tank:tankStopMove()
    self:stopAllActions()
    self.isMoving = false
end



--坦克开火
function Tank:tankFire()
    if self.fireCalmDown == false then

        local tankX, tankY = self:getPosition()
        local bullet = Bullet:create(self.direction, tankX, tankY, true)
        self:getParent():addChild(bullet, 1, 2)
        bullet:fly()
        self.fireCalmDown = true
        return true
    else
        return false
    end
    return false
end
--local function tankStopRun(sprite)
--    sprite:stopAllActions()
--end

--坦克移动动画
--function Tank:startMoveAction()
--    --保存重复动画？
--    local spriteFrame = cc.SpriteFrameCache:getInstance()
--    spriteFrame:addSpriteFrames("tank.plist")
--
--    local animation = cc.Animation:create()
--    for i = 1, 2 do
--        local frameName = string.format("tank_move_%d.png", i)
--        --cclog("frameName = %s", frameName)
--        local tankFrame = spriteFrame:getSpriteFrame(frameName)
--        animation:addSpriteFrame(tankFrame)
--    end
--
--    animation:setDelayPerUnit(0.15)
--    animation:setRestoreOriginalFrame(true)
--    local action = cc.Animate:create(animation)
--    return action
--    --self:runAction(cc.RepeatForever:create(action))
--end

--退出时释放动画

return Tank